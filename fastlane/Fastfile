default_platform(:ios)

platform :ios do
  desc "メタデータとスクリーンショットをアップロード"
  lane :upload_metadata do
    setup_api_key
    deliver(
      skip_binary_upload: true,
      skip_app_version_update: true,
      force: true,
      run_precheck_before_submit: false
    )
  end

  desc "スクリーンショットのみアップロード"
  lane :upload_screenshots do
    setup_api_key
    deliver(
      skip_binary_upload: true,
      skip_metadata: true,
      force: true,
      run_precheck_before_submit: false
    )
  end

  desc "メタデータをダウンロード"
  lane :download_metadata do
    sh("bundle exec fastlane deliver download_metadata --api_key_path ../fastlane/api_key.json")
    sh("bundle exec fastlane deliver download_screenshots --api_key_path ../fastlane/api_key.json")
  end

  desc "スクリーンショットを撮影"
  lane :screenshots do
    # 使用するシミュレータを起動してライトモードに設定
    devices = ["iPhone 17 Pro Max", "iPad Pro 13-inch (M5)"]
    devices.each do |device|
      # シミュレータを起動
      sh("xcrun simctl boot '#{device}' 2>/dev/null || true")
      # ライトモードに設定
      sh("xcrun simctl ui '#{device}' appearance light 2>/dev/null || true")
    end
    capture_screenshots
  end

  desc "スクリーンショットにデバイスフレームとテキストを追加"
  lane :add_frames do
    # Frameitでフレーム追加
    frameit(
      white: true,
      path: "./fastlane/screenshots"
    )

    # アルファチャンネル除去 & 圧縮（App Store Connect対応）
    screenshots_path = File.expand_path("../screenshots", __FILE__)
    Dir.glob("#{screenshots_path}/**/*_framed.png").each do |file|
      UI.message("Post-processing: #{File.basename(file)}")
      sh("magick '#{file}' -background white -alpha remove -alpha off '#{file}'")
      sh("pngquant --force --quality=80-95 --output '#{file}' '#{file}'")
    end

    UI.success("フレーム追加完了!")
  end

  desc "スクリーンショット撮影 + フレーム追加"
  lane :marketing_screenshots do
    screenshots
    add_frames
  end
end

def setup_api_key
  # CI環境: 環境変数から読み込み
  if ENV["APP_STORE_CONNECT_API_KEY_KEY_ID"]
    app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_API_KEY_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_API_KEY_ISSUER_ID"],
      key_content: ENV["APP_STORE_CONNECT_API_KEY_KEY"]
    )
  # ローカル環境: JSONファイルから読み込み
  elsif File.exist?("api_key.json")
    api_key_json = JSON.parse(File.read("api_key.json"))
    app_store_connect_api_key(
      key_id: api_key_json["key_id"],
      issuer_id: api_key_json["issuer_id"],
      key_content: api_key_json["key"]
    )
  else
    UI.user_error!("API key not found. Create fastlane/api_key.json from api_key.json.template")
  end
end
