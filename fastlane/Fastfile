default_platform(:ios)

platform :ios do
  desc "メタデータとスクリーンショットをアップロード"
  lane :upload_metadata do |options|
    setup_api_key
    deliver(
      skip_binary_upload: true,
      skip_app_version_update: true,
      skip_screenshots: options[:skip_screenshots] || false,
      overwrite_screenshots: true,
      force: true,
      run_precheck_before_submit: false
    )
  end

  desc "スクリーンショットのみアップロード"
  lane :upload_screenshots do
    setup_api_key
    deliver(
      skip_binary_upload: true,
      skip_metadata: true,
      overwrite_screenshots: true,
      force: true,
      run_precheck_before_submit: false
    )
  end

  desc "メタデータをダウンロード"
  lane :download_metadata do
    sh("bundle exec fastlane deliver download_metadata --api_key_path ../fastlane/api_key.json")
    sh("bundle exec fastlane deliver download_screenshots --api_key_path ../fastlane/api_key.json")
  end

  # プライベートレーン: marketing_screenshotsから呼び出す
  # 直接実行すると手動スクショがコピーされないため非公開
  private_lane :capture_app_screenshots do
    # 使用するシミュレータを起動してライトモードに設定
    devices = ["iPhone 17 Pro Max", "iPad Pro 13-inch (M5)"]
    devices.each do |device|
      # シミュレータを起動
      sh("xcrun simctl boot '#{device}' 2>/dev/null || true")
      # ライトモードに設定
      sh("xcrun simctl ui '#{device}' appearance light 2>/dev/null || true")
    end
    capture_screenshots
  end

  desc "スクリーンショットにデバイスフレームとテキストを追加"
  lane :add_frames do
    # Frameitでフレーム追加
    frameit(
      white: true,
      path: "./fastlane/screenshots"
    )

    # アルファチャンネル除去 & 圧縮（App Store Connect対応）
    screenshots_path = File.expand_path("../screenshots", __FILE__)
    Dir.glob("#{screenshots_path}/**/*_framed.png").each do |file|
      UI.message("Post-processing: #{File.basename(file)}")
      sh("magick '#{file}' -background white -alpha remove -alpha off '#{file}'")
      sh("pngquant --force --quality=80-95 --output '#{file}' '#{file}'")
    end

    # プレビューHTML生成
    generate_preview_html(screenshots_path)

    UI.success("フレーム追加完了!")
  end

  desc "スクリーンショット撮影 + フレーム追加"
  lane :marketing_screenshots do
    capture_app_screenshots
    copy_manual_screenshots
    add_frames
  end

  desc "手動スクリーンショットをコピー"
  lane :copy_manual_screenshots do
    manual_path = File.expand_path("../screenshots-manual", __FILE__)
    screenshots_path = File.expand_path("../screenshots", __FILE__)

    ["ja", "en-US"].each do |lang|
      src_dir = "#{manual_path}/#{lang}"
      dst_dir = "#{screenshots_path}/#{lang}"

      next unless Dir.exist?(src_dir)

      Dir.glob("#{src_dir}/*.png").each do |file|
        FileUtils.cp(file, dst_dir)
        UI.message("Copied: #{File.basename(file)}")
      end
    end

    UI.success("手動スクリーンショットをコピーしました")
  end

  desc "フレーム付きスクリーンショットのプレビューHTMLを生成"
  lane :generate_preview do
    screenshots_path = File.expand_path("../screenshots", __FILE__)
    generate_preview_html(screenshots_path)
  end
end

def setup_api_key
  # CI環境: 環境変数から読み込み
  if ENV["APP_STORE_CONNECT_API_KEY_KEY_ID"]
    app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_API_KEY_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_API_KEY_ISSUER_ID"],
      key_content: ENV["APP_STORE_CONNECT_API_KEY_KEY"]
    )
  # ローカル環境: JSONファイルから読み込み
  elsif File.exist?("api_key.json")
    api_key_json = JSON.parse(File.read("api_key.json"))
    app_store_connect_api_key(
      key_id: api_key_json["key_id"],
      issuer_id: api_key_json["issuer_id"],
      key_content: api_key_json["key"]
    )
  else
    UI.user_error!("API key not found. Create fastlane/api_key.json from api_key.json.template")
  end
end

def generate_preview_html(screenshots_path)
  # フレーム付きスクリーンショットがあるディレクトリのみを対象（fontsなど除外）
  languages = Dir.glob("#{screenshots_path}/*/").select { |d|
    Dir.glob("#{d}*_framed.png").any?
  }.map { |d| File.basename(d) }.sort

  html = <<~HTML
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <title>Framed Screenshots Preview</title>
      <style>
        * { font-family: -apple-system, BlinkMacSystemFont, sans-serif; }
        body { margin: 20px; background: #f5f5f7; }
        h1 { color: #1d1d1f; }
        h2 { color: #86868b; margin-top: 40px; border-bottom: 1px solid #d2d2d7; padding-bottom: 10px; }
        .device-section { margin-bottom: 30px; }
        .device-name { font-size: 18px; font-weight: 600; color: #1d1d1f; margin: 20px 0 10px; }
        .screenshots { display: flex; flex-wrap: wrap; gap: 20px; }
        .screenshot-card { background: white; border-radius: 12px; padding: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .screenshot-card img { max-height: 400px; width: auto; border-radius: 8px; cursor: pointer; }
        .screenshot-card img:hover { opacity: 0.9; }
        .caption { font-size: 12px; color: #86868b; margin-top: 8px; text-align: center; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab { padding: 10px 20px; background: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; }
        .tab.active { background: #0071e3; color: white; }
        .lang-section { display: none; }
        .lang-section.active { display: block; }
        #overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; cursor: zoom-out; }
        #overlay img { max-width: 95%; max-height: 95%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
      </style>
    </head>
    <body>
      <h1>Framed Screenshots Preview</h1>
      <div class="tabs">
  HTML

  # タブボタン生成
  languages.each_with_index do |lang, i|
    active = i == 0 ? " active" : ""
    html += "    <button class=\"tab#{active}\" onclick=\"showLang('#{lang}')\">#{lang}</button>\n"
  end
  html += "  </div>\n"

  # 各言語のセクション
  languages.each_with_index do |lang, i|
    active = i == 0 ? " active" : ""
    html += "  <div id=\"#{lang}\" class=\"lang-section#{active}\">\n"

    framed_files = Dir.glob("#{screenshots_path}/#{lang}/*_framed.png").sort

    # デバイスごとにグループ化
    devices = framed_files.group_by { |f| File.basename(f).split("-")[0..-2].join("-").gsub(/_framed\.png$/, "") }

    devices.each do |device, files|
      html += "    <div class=\"device-section\">\n"
      html += "      <div class=\"device-name\">#{device}</div>\n"
      html += "      <div class=\"screenshots\">\n"

      files.sort.each do |file|
        filename = File.basename(file)
        screen_name = filename.gsub(/.*-(\d+_.*)_framed\.png/, '\1')
        html += "        <div class=\"screenshot-card\">\n"
        html += "          <img src=\"./#{lang}/#{filename}\" alt=\"#{screen_name}\" onclick=\"showOverlay(this.src)\">\n"
        html += "          <div class=\"caption\">#{screen_name}</div>\n"
        html += "        </div>\n"
      end

      html += "      </div>\n"
      html += "    </div>\n"
    end

    html += "  </div>\n"
  end

  html += <<~HTML
      <div id="overlay" onclick="this.style.display='none'">
        <img id="overlayImg" src="" alt="">
      </div>
      <script>
        function showLang(lang) {
          document.querySelectorAll('.lang-section').forEach(s => s.classList.remove('active'));
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.getElementById(lang).classList.add('active');
          event.target.classList.add('active');
        }
        function showOverlay(src) {
          document.getElementById('overlayImg').src = src;
          document.getElementById('overlay').style.display = 'block';
        }
      </script>
    </body>
    </html>
  HTML

  output_path = "#{screenshots_path}/framed_preview.html"
  File.write(output_path, html)
  UI.success("プレビューHTML生成: #{output_path}")
end
